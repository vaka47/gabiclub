name: ðŸš€ Deploy to REG.RU Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ” Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.REG_RU_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: ðŸ” Show SSH key fingerprint
        run: |
          echo "ðŸ”‘ SSH Key Fingerprint:"
          ssh-keygen -lf ~/.ssh/id_ed25519 || echo "âŒ ÐšÐ»ÑŽÑ‡ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð½Ðµ Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ"

      - name: ðŸ“¬ Add REG.RU to known_hosts
        run: ssh-keyscan server295.hosting.reg.ru >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to REG.RU server
        run: |
          echo "ðŸ“¡ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ SSH..."
          ssh -i ~/.ssh/id_ed25519 u3187320@server295.hosting.reg.ru << 'EOF'
            echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ!"
            cd ~/gabiclub || exit 1
            git pull origin main || exit 1
            echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾. Ð—Ð°Ð¿ÑƒÑÐº ÑÐ±Ð¾Ñ€ÐºÐ¸..."
            npm install || exit 1
            npm run build || exit 1
            pm2 restart frontend || echo "âš ï¸ pm2 Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
          EOF

