name: ğŸš€ Deploy to REG.RU

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”½ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ›¡ï¸ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.REG_RU_DEPLOY_KEY }}" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy

          echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° fingerprint:"
          ssh-keygen -lf ~/.ssh/id_deploy || echo "âŒ ĞšĞ»ÑÑ‡ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½"

      - name: ğŸ“¡ Deploy to REG.RU
        run: |
          echo "ğŸ“¡ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ SSH..."
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no u3187320@server295.hosting.reg.ru << 'EOF'
            echo "âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ!"
            cd ~/gabiclub || exit 1
            git pull origin main || exit 1
            echo "ğŸ“¦ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾. Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞ±Ğ¾Ñ€ĞºĞ¸..."
            npm install || exit 1
            npm run build || exit 1
            pm2 restart frontend || echo "âš ï¸ pm2 Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
          EOF
