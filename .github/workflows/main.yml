
name: 🚀 Deploy to REG.RU (gabiclub.ru)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout repo
        uses: actions/checkout@v3

      - name: 🔐 Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.REG_RU_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H server295.hosting.reg.ru >> ~/.ssh/known_hosts
        shell: bash

      - name: 📡 Connect via SSH and deploy
        run: |
          echo "📡 Подключение по SSH..."
          ssh -i ~/.ssh/id_ed25519 u3187320@server295.hosting.reg.ru << 'EOF'
            echo "✅ Успешное подключение!"
            cd ~/gabiclub || exit 1
            git pull origin main || exit 1
            echo "📦 Обновлено. Запуск сборки..."
            npm install || exit 1
            npm run build || exit 1
            pm2 restart frontend || echo "⚠️ pm2 не найден или процесс не существует"
          EOF
