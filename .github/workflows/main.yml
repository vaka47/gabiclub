name: üöÄ Deploy Frontend via SSH

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v3

      - name: üîê Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.REG_RU_DEPLOY_USER }}
          key: ${{ secrets.REG_RU_DEPLOY_KEY }}
          port: 22
          script: |
            echo "üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ SSH..."
            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!"

            cd ~/gabiclub/frontend

            echo "üîÑ Git Pull..."
            git pull origin main

            echo "üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Node 20 –≤ PATH..."
            export PATH="$HOME/.nvm/versions/node/v20.14.0/bin:$PATH"

            echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ Node –∏ NPM..."
            node -v || nvm use 20
            npm -v

            echo "üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
            chmod -R u+rwX,g+rwX,o+rX node_modules || true
            chmod -R u+x node_modules/.bin || true

            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            npm install

            echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
            npm install -g pm2

            echo "üõ† –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
            npm run build

            echo "‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."
            pm2 reload frontend || pm2 start npm --name "frontend" -- run start

