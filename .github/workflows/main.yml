name: üöÄ Deploy to REG.RU

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîΩ Checkout code
        uses: actions/checkout@v3

      - name: üõ°Ô∏è Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.REG_RU_DEPLOY_KEY }}" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          ssh-keygen -lf ~/.ssh/id_deploy || echo "‚ùå –ö–ª—é—á –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω"

           - name: üì° Deploy to REG.RU
  run: |
    echo "üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ SSH..."
    ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no u3187320@server295.hosting.reg.ru << 'EOF'
      echo "‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!"
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm use 18 || exit 1

      cd ~/gabiclub || exit 1
      git pull origin main || exit 1

      echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–æ. –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏..."
      cd frontend || exit 1
      npm install || exit 1
      npm run build || exit 1

      pm2 restart frontend || echo "‚ö†Ô∏è pm2 –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    EOF

