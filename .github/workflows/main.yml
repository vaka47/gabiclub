name: üöÄ Deploy to REG.RU

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîΩ Checkout code
        uses: actions/checkout@v3

      - name: üõ°Ô∏è Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.REG_RU_DEPLOY_KEY }}" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          ssh-keygen -lf ~/.ssh/id_deploy || echo "‚ùå –ö–ª—é—á –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω"

      - name: üì° Deploy to REG.RU
        run: |
          echo "üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ SSH..."
          ssh -T -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no u3187320@server295.hosting.reg.ru << 'EOF'
            set -e

            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!"

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 18

            echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é ~/gabiclub"
            cd ~/gabiclub

            echo "üì¶ Git pull..."
            git pull origin main

            echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥ –≤ frontend"
            cd frontend

            echo "üßπ –ü–æ—á–∏–Ω–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ node_modules"
            chmod -R u+rx node_modules/.bin || true

            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
            npm install

            echo "üõ†Ô∏è –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
            npm run build

            echo "üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ pm2"
            pm2 restart frontend || echo "‚ö†Ô∏è pm2 –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
          EOF
