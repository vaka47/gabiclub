name: Deploy Frontend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          timeout: 30s
          command_timeout: 30m
          script: |
            # Prevent npm install/build from being killed on low-memory VPS.
            if ! swapon --show | grep -q '^'; then
              if [ ! -f /swapfile ]; then
                fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
                chmod 600 /swapfile
                mkswap /swapfile
              fi
              swapon /swapfile || true
            fi
            bash /var/www/gabi-frontend/deploy.sh

            # Verify that the deployed source really contains the dark hero stats color.
            if [ -f /var/www/gabi-frontend/frontend/src/components/HeroSection.tsx ]; then
              echo "Checking deployed HeroSection.tsx for #334155..."
              grep -n '#334155' /var/www/gabi-frontend/frontend/src/components/HeroSection.tsx || true
            fi

            # Keep only canonical PM2 app name used by deploy.sh.
            if [ -d /var/www/gabi-frontend/frontend ]; then
              cd /var/www/gabi-frontend/frontend
              pm2 delete frontend || true
              pm2 restart gabi-frontend || true
              pm2 save || true
              pm2 status || true
            fi
